## 缘由

在知名的TCP详解三卷中的卷一中，关于IP协议章节中，作者介绍了Internet校验和算法，不过在介绍该算法时，作者也简单聊了一下该算法的数学性质，这些信息在原书128页（中文翻译版本）。

作者的描述十分简短，就几行，只是证明了{0001,.....FFFF}这个集合是一个阿贝尔群，甚至都看不出与Internet校验和算法有什么关系，因此笔者还是简单补充一下。



## 理论

Internet校验和算法如下，在笔者编写的TCP/IP协议栈SKRTOS_tcp中使用了这段代码：

其实就是将所有内容看成是十六位的字，将它们相加，然后进行循环进位，最后返回其反码。

```
unsigned short in_checksum(void *b, int len) 
{
    unsigned short *addr = (unsigned short *)b;
    long sum = 0;

    for (len; len > 1; len -= 2) {
        sum += *(unsigned short *)addr++;
        if (sum & 0x80000000) {
            sum = (sum & 0xFFFF) + (sum >> 16);
        }
    }
    if (len) {
        sum += (unsigned short)(*(unsigned char *)addr);
    }
    while(sum >> 16) {
        sum = (sum >> 16) + (sum & 0xFFFF);
    }

    return ~sum;
}
```

## 性质

对于{0001,.....FFFF}这个集合V是一个阿贝尔群，证明如下：

1.对于V中的任何X,Y,（X + Y）都在V中 （封闭性）

2.对于V中的任何X,Y,Z, X + (Y + Z）= (X + Y) + Z     (结合性)

3.对于V中的任何X,（e + X）= X + e = X, 其中e = FFFF （单位元）

4.对于V中的任何X,Y, 有一个X'在V中，使得X + X' = e （逆元）

5.对于V中的任何X,Y, X  + Y = Y + X  （可交换）

那么Internet校验和是否符合上面的性质呢？

Internet校验和算法的运算确实是阿贝尔群，但并不是上面的集合，而是{0000,.....FFFF}集合P

对于集合V，如果引入0000这个元素，那么就有两个单位元了，这个集合就不会构成阿贝尔群。

但是，我们的Internet校验和算法并不是十六位运算，而是先用一个long类型的变量存储所有十六位字的内容，也就是说，FFFF并不是单位元，0000才是，因此，它是加法运算，自然符合阿贝尔群。

那么，也就是说，现在的Internet校验和算法中的内容是可交换的，只要我没有更改其中的值，而只是替换十六位字内容的顺序，Internet校验和算法的结果不会有任何影响。

如何破坏该算法的性质呢？如果我们想检验内容中的字的顺序，那么肯定不能让该集合构成一个阿贝尔群了。

其实很简单，不使用long类型存储求和结合，而是使用short类型，那么，此时FFFF也成为了单位元，自然就不是阿贝尔群了，求和的顺序不同，结果也不同。

